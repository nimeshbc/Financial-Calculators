<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWP Calculator</title>
    <!-- Chart.js for beautiful visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
            line-height: 1.6; 
            background-color: #f0f4f8; 
            color: #333;
        }
        .container { 
            max-width: 900px; /* Increased max width for chart/table */
            margin: 30px auto; 
            padding: 30px; 
            background-color: #ffffff; 
            border-radius: 12px; 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); 
        }
        h1 { 
            color: #007bff; 
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 1.8rem;
            border-bottom: 2px solid #007bff33;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .input-group { 
            margin-bottom: 20px; 
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555;
            font-size: 0.95rem;
        }
        input[type="number"] { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus {
            border-color: #007bff;
            outline: none;
        }
        /* Style for the amount in words display */
        .word-display {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #007bff;
            font-weight: 500;
            text-transform: capitalize;
        }
        button { 
            width: 100%;
            padding: 12px;
            background-color: #28a745; /* Success Green */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 15px;
        }
        button:hover { 
            background-color: #1e8734; 
            transform: translateY(-1px);
        }
        #results { 
            margin-top: 30px; 
            padding: 20px; 
            background-color: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 1.2rem;
            text-align: center;
            font-weight: bold;
        }

        /* Chart and Table Styling */
        #chartContainer {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        #breakdownTableContainer {
            margin-top: 30px;
            overflow-x: auto; /* Allows horizontal scrolling for table */
            max-height: 500px; /* Added max height to allow scrolling for long tables */
            overflow-y: auto;
        }
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .breakdown-table th, .breakdown-table td {
            padding: 10px 8px;
            border: 1px solid #e0e0e0;
            text-align: right;
        }
        .breakdown-table th {
            background-color: #007bff;
            color: white;
            text-align: center;
            position: sticky;
            top: 0; /* Makes the header sticky when scrolling vertically */
            z-index: 10;
        }
        .breakdown-table td:nth-child(1),
        .breakdown-table td:nth-child(2) {
            text-align: center !important; /* Center align Year and Month columns */
        }

        .table-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }
        /* Responsive adjustments for smaller screens */
        @media (max-width: 650px) {
            body { padding: 10px; }
            .container { margin: 10px auto; padding: 20px; }
        }
    </style>
</head>
<body onload="updateInitialValues()">

    <div class="container">
        <h1>Systematic Withdrawal Plan (SWP) Calculator 💰</h1>

        <div class="input-group">
            <label for="initialAmount">Initial Investment Amount (INR)</label>
            <input type="number" id="initialAmount" value="5000000" min="0" oninput="updateWordDisplay('initialAmount', 'initialAmountWords')">
            <span id="initialAmountWords" class="word-display"></span>
        </div>

        <div class="input-group">
            <label for="monthlyWithdrawal">Starting Monthly Withdrawal (INR)</label>
            <input type="number" id="monthlyWithdrawal" value="30000" min="0" oninput="updateWordDisplay('monthlyWithdrawal', 'monthlyWithdrawalWords')">
            <span id="monthlyWithdrawalWords" class="word-display"></span>
        </div>
        
        <div class="input-group">
            <label for="years">Withdrawal Tenure (Years)</label>
            <input type="number" id="years" value="15" min="1" step="1">
        </div>
        
        <div class="input-group">
            <label for="annualReturn">Expected Annual Return (%)</label>
            <input type="number" id="annualReturn" value="10" min="0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="expenseIncrease">Annual Increase in Withdrawal (%) (Inflation)</label>
            <input type="number" id="expenseIncrease" value="5" min="0" step="0.1">
        </div>

        <button onclick="calculateSWP()">Calculate Final Corpus & Generate Analysis</button>

        <div id="results">
            Enter values and click Calculate.
        </div>
        
        <!-- Chart Section -->
        <h2 id="chartSectionTitle" style="display:none;">Corpus Balance Over Time</h2>
        <div id="chartContainer" style="display:none;">
            <canvas id="swpChart"></canvas>
        </div>
        
        <!-- Table Section -->
        <h2 id="tableSectionTitle" style="display:none;">Monthly Breakdown Table</h2>
        <div id="breakdownTableContainer">
            <!-- Table will be injected here -->
        </div>

    </div>

    <script>
        let swpChart; // Variable to hold the Chart.js instance

        // --- Utility Functions ---

        // Function to convert a number into Indian words (Lakhs, Crores)
        function numberToIndianWords(n) {
            if (n === 0) return 'Zero';
            const num = Math.floor(n);
            
            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

            function convertGroup(n, suffix) {
                let s = '';
                if (n >= 100) {
                    s += ones[Math.floor(n / 100)] + ' hundred ';
                    n %= 100;
                }
                if (n >= 20) {
                    s += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                }
                if (n > 0) {
                    s += ones[n] + ' ';
                }
                return s.trim() + (suffix ? ' ' + suffix : '');
            }

            let words = '';

            // Crores (up to 99)
            let crore = Math.floor(num / 10000000);
            if (crore > 0) {
                words += convertGroup(crore, 'crore') + ' ';
            }

            // Lakhs (up to 99)
            let lakh = Math.floor((num % 10000000) / 100000);
            if (lakh > 0) {
                words += convertGroup(lakh, 'lakh') + ' ';
            }

            // Thousands and Hundreds
            let thousandGroup = num % 100000;
            let thousand = Math.floor(thousandGroup / 1000);
            let remainder = thousandGroup % 1000;

            if (thousand > 0) {
                words += convertGroup(thousand, 'thousand') + ' ';
            }
            
            if (remainder > 0) {
                 if (thousand === 0 && Math.floor(num/100000) === 0) {
                    // This conditional block is redundant based on the grouping but kept for structural safety.
                 }
                 words += convertGroup(remainder, '');
            }
            
            let finalWords = words.replace(/\s+/g, ' ').trim();
            return finalWords ? finalWords + ' Rupees Only' : '';
        }

        // Updates the word display below input fields
        function updateWordDisplay(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            let value = parseFloat(input.value);
            
            if (isNaN(value) || value <= 0) {
                display.textContent = '';
            } else {
                value = Math.floor(value); 
                display.textContent = numberToIndianWords(value);
            }
        }

        // Initializes the word display on page load
        function updateInitialValues() {
            updateWordDisplay('initialAmount', 'initialAmountWords');
            updateWordDisplay('monthlyWithdrawal', 'monthlyWithdrawalWords');
        }

        // Formats number to Indian currency string
        function formatINR(number) {
            // Ensure numbers are rounded/formatted correctly before display
            return Math.round(number).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }


        // --- Core Calculation Function ---

        function calculateSWP() {
            // 1. Get Inputs and Validate
            const initialAmount = parseFloat(document.getElementById('initialAmount').value);
            const startingMonthlyWithdrawal = parseFloat(document.getElementById('monthlyWithdrawal').value);
            const years = parseInt(document.getElementById('years').value);
            const annualReturn = parseFloat(document.getElementById('annualReturn').value) / 100;
            const expenseIncrease = parseFloat(document.getElementById('expenseIncrease').value) / 100;
            
            const resultsDiv = document.getElementById('results');

            if (isNaN(initialAmount) || isNaN(startingMonthlyWithdrawal) || isNaN(years) || isNaN(annualReturn) || isNaN(expenseIncrease) || initialAmount < 0 || years < 1) {
                resultsDiv.innerHTML = '⚠️ Please enter valid, non-negative numbers for all fields and tenure must be at least 1 year.';
                return;
            }

            // Monthly compounding/discounting rates
            const monthlyReturn = Math.pow(1 + annualReturn, 1/12) - 1;
            
            let currentCorpus = initialAmount;
            let currentMonthlyWithdrawal = startingMonthlyWithdrawal;
            const monthlyData = [];
            
            let fundDepleted = false;
            let totalMonthCount = 0;

            // Loop through each year
            for (let y = 1; y <= years; y++) {
                
                // Monthly Iteration within the year
                for (let m = 1; m <= 12; m++) {
                    if (fundDepleted) break;
                    
                    totalMonthCount++; // Increment total month counter
                    const startBalance = currentCorpus;

                    // 1. Withdrawal happens at the start of the month
                    const withdrawalAmount = currentMonthlyWithdrawal;
                    currentCorpus -= withdrawalAmount;
                    
                    if (currentCorpus < 0) {
                        // Fund depleted on this withdrawal
                        fundDepleted = true;
                        currentCorpus = 0; // Set to zero for final display
                        break;
                    }
                    
                    // 2. Remaining corpus grows for the month
                    const interest = currentCorpus * monthlyReturn;
                    currentCorpus += interest;
                    const endBalance = currentCorpus;

                    monthlyData.push({
                        year: y, // Store year explicitly
                        month: m, // Store month explicitly
                        totalMonth: totalMonthCount, // Total month number for charting
                        startCorpus: startBalance,
                        withdrawal: withdrawalAmount,
                        interestEarned: interest,
                        endCorpus: endBalance
                    });
                }
                
                if (fundDepleted) break;

                // Annual increase in withdrawal amount (Inflation adjustment)
                currentMonthlyWithdrawal *= (1 + expenseIncrease);
            }
            
            // 2. Output Final Result
            const finalCorpus = currentCorpus;
            let finalMessage = '';

            if (fundDepleted) {
                finalMessage = `
                    <span style="color:red; font-size: 1.1rem;">
                        Corpus depleted! The fund ran out. The last successful withdrawal was at the end of Month ${monthlyData.length}.
                    </span>
                `;
            } else {
                finalMessage = `
                    <p>Final Corpus After ${years} Years:</p>
                    <strong>INR ${formatINR(finalCorpus)}</strong>
                `;
            }

            resultsDiv.innerHTML = finalMessage;
            
            // 3. Render Visualization and Table
            document.getElementById('chartSectionTitle').style.display = 'block';
            document.getElementById('tableSectionTitle').style.display = 'block';
            document.getElementById('chartContainer').style.display = 'block';

            renderChart(monthlyData);
            renderBreakdownTable(monthlyData);
        }

        // --- Chart Rendering Function (Chart.js) ---
        function renderChart(data) {
            const ctx = document.getElementById('swpChart').getContext('2d');

            // Destroy previous chart instance if it exists
            if (swpChart) {
                swpChart.destroy();
            }

            // Prepare labels: Use Month Number (1, 2, 3, ...) for primary plotting
            const labels = data.map(item => item.totalMonth); 
            const corpusValues = data.map(item => item.endCorpus);
            
            // Chart Configuration
            swpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Corpus Balance (INR)',
                        data: corpusValues,
                        borderColor: 'rgb(0, 123, 255)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        pointRadius: 1,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Corpus Value (INR)'
                            },
                            ticks: {
                                callback: function(value) {
                                    // Display Y-axis ticks in Lakhs/Crores for better readability
                                    if (value >= 10000000) return (value / 10000000).toFixed(1) + ' Cr';
                                    if (value >= 100000) return (value / 100000).toFixed(1) + ' L';
                                    return value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time in Years'
                            },
                            ticks: {
                                // Only show a label every 12 months, and label it as the year number
                                callback: function(value, index) {
                                    const totalMonths = value + 1; // Since labels are 1-indexed (totalMonth), value is the month index starting from 0.
                                    if (totalMonths % 12 === 0) {
                                        return `Year ${totalMonths / 12}`;
                                    }
                                    return null; // Hide intermediate ticks
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'INR ' + formatINR(context.parsed.y);
                                    }
                                    return label;
                                },
                                title: function(context) {
                                    // Use the explicit year and month stored in the data object for clear tooltips
                                    const item = data[context[0].dataIndex];
                                    return `Year ${item.year}, Month ${item.month} (Total Month ${item.totalMonth})`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Table Rendering Function ---
        function renderBreakdownTable(data) {
            const tableContainer = document.getElementById('breakdownTableContainer');
            if (data.length === 0) {
                tableContainer.innerHTML = '<p class="table-title">No monthly data to display (Corpus was too small).</p>';
                return;
            }

            let tableHTML = '<table class="breakdown-table">';
            tableHTML += '<thead><tr><th>Year</th><th>Month</th><th>Start Corpus (INR)</th><th>Monthly Withdrawal (INR)</th><th>Interest Earned (INR)</th><th>End Corpus (INR)</th></tr></thead>';
            tableHTML += '<tbody>';

            const maxMonthsToShow = data.length; 
            
            for (let i = 0; i < maxMonthsToShow; i++) {
                const item = data[i];
                tableHTML += `
                    <tr>
                        <td>${item.year}</td>
                        <td>${item.month}</td>
                        <td>${formatINR(item.startCorpus)}</td>
                        <td>${formatINR(item.withdrawal)}</td>
                        <td style="color:${item.interestEarned > 0 ? '#1e8734' : 'black'};">${formatINR(item.interestEarned)}</td>
                        <td style="font-weight: bold;">${formatINR(item.endCorpus)}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }

    </script>

</body>
</html>
